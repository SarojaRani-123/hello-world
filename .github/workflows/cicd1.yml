name: CI-CD Pipeline
 
on:
  workflow_dispatch:
    inputs:
      client:
        description: 'Client Name'
        required: true
      environment:
        description: 'Environment (dev/stage/prod)'
        required: true
      version:
        description: 'Artifact Version (e.g. v8.2025.06)'
        required: true
 
jobs:
  build-and-deploy:
    runs-on: windows-latest
 
    steps:
      - name: Step 1 - Checkout repo
        uses: actions/checkout@v4
 
      - name: Step 2 - Set variables
        shell: pwsh
        run: |
          echo "CLIENT=${{ github.event.inputs.client }}" >> $env:GITHUB_ENV
          echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $env:GITHUB_ENV
          echo "VERSION=${{ github.event.inputs.version }}" >> $env:GITHUB_ENV
          echo "ARTIFACTS_DIR=${{ github.workspace }}\\artifacts\\artifacts_${{ github.event.inputs.version }}" >> $env:GITHUB_ENV
 
      - name: Step 3 - Verify artifacts folder
        shell: pwsh
        run: |
          echo "Looking inside: $env:ARTIFACTS_DIR"
          Get-ChildItem -Path "$env:ARTIFACTS_DIR"
 
      - name: Step 4 - Extract all zip files
        shell: pwsh
        run: |
          echo "Extracting all .zip files from $env:ARTIFACTS_DIR"
          Get-ChildItem -Path "$env:ARTIFACTS_DIR" -Filter *.zip | ForEach-Object {
            $dest = Join-Path $_.DirectoryName ($_.BaseName)
            echo "Extracting $($_.Name) -> $dest"
            Expand-Archive -Path $_.FullName -DestinationPath $dest -Force
          }
 
      - name: Step 5 - Deploy using MSDeploy
        shell: pwsh
        run: |
          echo "Starting MSDeploy for $env:CLIENT - $env:ENVIRONMENT"
          $unzippedDirs = Get-ChildItem -Path "$env:ARTIFACTS_DIR" -Directory
          foreach ($dir in $unzippedDirs) {
            echo "Deploying $($dir.FullName)"
            & "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe" `
              -verb:sync `
              -source:iisApp="$($dir.FullName)" `
              -dest:iisApp="$env:CLIENT-$env:ENVIRONMENT",computerName="https://targetserver:8172/msdeploy.axd",userName="USERNAME",password="PASSWORD",authType="Basic" `
              -allowUntrusted
          }
 
      - name: Step 6 - Cleanup extracted folders
        shell: pwsh
        run: |
          echo "Cleaning up extracted folders..."
          Get-ChildItem -Path "$env:ARTIFACTS_DIR" -Directory | ForEach-Object {
            echo "Removing $($_.FullName)"
            Remove-Item -Recurse -Force -Path $_.FullName
          }
 
      - name: Step 7 - Success message
        run: echo "âœ… Deployment completed successfully for ${{ github.event.inputs.client }} - ${{ github.event.inputs.environment }} - version ${{ github.event.inputs.version }}"
